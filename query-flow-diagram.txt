┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                          RAG CHATBOT QUERY FLOW DIAGRAM                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: FRONTEND - USER INTERACTION                                                         │
│  (frontend/script.js)                                                                        │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  User enters: "What is MCP?"                                                                 │
│       │                                                                                      │
│       ├─► chatInput.value.trim()                                                             │
│       │                                                                                      │
│       └─► fetch('/api/query', {                                                              │
│              method: 'POST',                                                                 │
│              body: JSON.stringify({                                                          │
│                query: "What is MCP?",                                                        │
│                session_id: null          ◄── First query, no session yet                    │
│              })                                                                              │
│           })                                                                                 │
│                │                                                                             │
│                │ HTTP POST                                                                   │
│                ▼                                                                             │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: API ENDPOINT - REQUEST HANDLING                                                     │
│  (backend/app.py)                                                                            │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  @app.post("/api/query")                                                                     │
│  async def query_documents(request: QueryRequest):                                           │
│       │                                                                                      │
│       ├─► if not session_id:                                                                 │
│       │       session_id = rag_system.session_manager.create_session()                       │
│       │       # Creates "session_1"                                                          │
│       │                                                                                      │
│       └─► answer, sources = rag_system.query(request.query, session_id)                      │
│                │                                                                             │
│                ▼                                                                             │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: RAG SYSTEM - ORCHESTRATION                                                          │
│  (backend/rag_system.py)                                                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  def query(query: str, session_id: str):                                                     │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 3a. Get Conversation History                                                │            │
│  │     history = session_manager.get_conversation_history(session_id)          │            │
│  │     # Returns: "User: ...\nAssistant: ..." or None                          │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 3b. Get Tool Definitions                                                    │            │
│  │     tools = tool_manager.get_tool_definitions()                             │            │
│  │     # Returns: [{"name": "search_course_content", ...}]                     │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 3c. Call AI Generator                                                       │            │
│  │     response = ai_generator.generate_response(                              │            │
│  │         query=query,                                                        │            │
│  │         conversation_history=history,                                       │            │
│  │         tools=tools,                                                        │            │
│  │         tool_manager=tool_manager                                           │            │
│  │     )                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: AI GENERATOR - FIRST CLAUDE API CALL                                                │
│  (backend/ai_generator.py)                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  def generate_response(...):                                                                 │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 4a. Build System Prompt + History                                           │            │
│  │     system_content = SYSTEM_PROMPT + conversation_history                   │            │
│  │                                                                              │            │
│  │     SYSTEM_PROMPT includes:                                                 │            │
│  │     - "You are an AI assistant specialized in course materials..."          │            │
│  │     - "Use search tool for course-specific questions"                       │            │
│  │     - "One search per query maximum"                                        │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 4b. Call Claude API with Tools                                              │            │
│  │     response = client.messages.create(                                      │            │
│  │         model="claude-sonnet-4-20250514",                                   │            │
│  │         temperature=0,                                                      │            │
│  │         max_tokens=800,                                                     │            │
│  │         messages=[{"role": "user", "content": query}],                      │            │
│  │         system=system_content,                                              │            │
│  │         tools=tools,                    ◄── Tool definitions                │            │
│  │         tool_choice={"type": "auto"}    ◄── Let Claude decide               │            │
│  │     )                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════╗              │
│  ║  CLAUDE RESPONSE (stop_reason: "tool_use")                                ║              │
│  ╠═══════════════════════════════════════════════════════════════════════════╣              │
│  ║  {                                                                        ║              │
│  ║    "content": [                                                           ║              │
│  ║      {                                                                    ║              │
│  ║        "type": "tool_use",                                                ║              │
│  ║        "name": "search_course_content",                                   ║              │
│  ║        "id": "toolu_01ABC123",                                            ║              │
│  ║        "input": {                                                         ║              │
│  ║          "query": "MCP"                                                   ║              │
│  ║        }                                                                  ║              │
│  ║      }                                                                    ║              │
│  ║    ]                                                                      ║              │
│  ║  }                                                                        ║              │
│  ╚═══════════════════════════════════════════════════════════════════════════╝              │
│                                  │                                                           │
│                                  │ Claude decided to search!                                 │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 5: TOOL EXECUTION - HANDLE TOOL CALLS                                                  │
│  (backend/ai_generator.py → search_tools.py)                                                 │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  def _handle_tool_execution(initial_response, ...):                                          │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 5a. Extract Tool Call Details                                               │            │
│  │     for content_block in initial_response.content:                          │            │
│  │         if content_block.type == "tool_use":                                │            │
│  │             tool_name = "search_course_content"                             │            │
│  │             tool_input = {"query": "MCP"}                                   │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 5b. Execute Tool via ToolManager                                            │            │
│  │     tool_result = tool_manager.execute_tool(                                │            │
│  │         "search_course_content",                                            │            │
│  │         query="MCP"                                                         │            │
│  │     )                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐   │
│  │  CourseSearchTool.execute(query="MCP")                                               │   │
│  │  (backend/search_tools.py)                                                           │   │
│  │                                                                                      │   │
│  │  results = self.store.search(query="MCP", course_name=None, lesson_number=None)     │   │
│  └──────────────────────────────────────────────────────────────────────────────────────┘   │
│                                  │                                                           │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 6: VECTOR STORE - SEMANTIC SEARCH                                                      │
│  (backend/vector_store.py)                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  def search(query, course_name, lesson_number):                                              │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 6a. Resolve Course Name (if provided)                                       │            │
│  │     # Skipped - no course_name filter in this case                          │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 6b. Build Filter (if needed)                                                │            │
│  │     filter_dict = None  # No filters                                        │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 6c. Query ChromaDB with Vector Search                                       │            │
│  │     results = self.course_content.query(                                    │            │
│  │         query_texts=["MCP"],           ◄── Embedded to vector                │            │
│  │         n_results=5,                   ◄── Max results from config           │            │
│  │         where=None                     ◄── No filters                        │            │
│  │     )                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════╗              │
│  ║  CHROMADB RESULTS                                                         ║              │
│  ╠═══════════════════════════════════════════════════════════════════════════╣              │
│  ║  {                                                                        ║              │
│  ║    "documents": [[                                                        ║              │
│  ║      "Lesson 1 content: MCP stands for Model Context Protocol...",        ║              │
│  ║      "Course Building Agentic RAG Lesson 2 content: MCP enables...",      ║              │
│  ║      ...                                                                  ║              │
│  ║    ]],                                                                    ║              │
│  ║    "metadatas": [[                                                        ║              │
│  ║      {"course_title": "Building Agentic RAG...", "lesson_number": 1},    ║              │
│  ║      {"course_title": "Building Agentic RAG...", "lesson_number": 2},    ║              │
│  ║      ...                                                                  ║              │
│  ║    ]],                                                                    ║              │
│  ║    "distances": [[0.23, 0.31, 0.45, 0.52, 0.61]]                         ║              │
│  ║  }                                                                        ║              │
│  ╚═══════════════════════════════════════════════════════════════════════════╝              │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  return SearchResults.from_chroma(results)                                                   │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 7: FORMAT RESULTS - PREPARE FOR CLAUDE                                                 │
│  (backend/search_tools.py)                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  def _format_results(results: SearchResults):                                                │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 7a. Build Formatted Context                                                 │            │
│  │     for doc, meta in zip(results.documents, results.metadata):              │            │
│  │         course_title = meta['course_title']                                 │            │
│  │         lesson_num = meta['lesson_number']                                  │            │
│  │                                                                              │            │
│  │         header = f"[{course_title} - Lesson {lesson_num}]"                  │            │
│  │         formatted.append(f"{header}\n{doc}")                                │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 7b. Track Sources for UI                                                    │            │
│  │     sources.append(f"{course_title} - Lesson {lesson_num}")                 │            │
│  │     self.last_sources = sources  # Store in tool                            │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════╗              │
│  ║  FORMATTED TOOL RESULT                                                    ║              │
│  ╠═══════════════════════════════════════════════════════════════════════════╣              │
│  ║  [Building Agentic RAG with Claude - Lesson 1]                            ║              │
│  ║  Lesson 1 content: MCP stands for Model Context Protocol...               ║              │
│  ║                                                                            ║              │
│  ║  [Building Agentic RAG with Claude - Lesson 2]                            ║              │
│  ║  Course Building Agentic RAG Lesson 2 content: MCP enables...             ║              │
│  ║                                                                            ║              │
│  ║  ... (3 more results)                                                     ║              │
│  ╚═══════════════════════════════════════════════════════════════════════════╝              │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 8: AI GENERATOR - SECOND CLAUDE API CALL                                               │
│  (backend/ai_generator.py)                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 8a. Build Messages with Tool Results                                        │            │
│  │     messages = [                                                            │            │
│  │         {"role": "user", "content": "Answer... What is MCP?"},              │            │
│  │         {"role": "assistant", "content": [tool_use_block]},                 │            │
│  │         {"role": "user", "content": [                                       │            │
│  │             {                                                                │            │
│  │                 "type": "tool_result",                                      │            │
│  │                 "tool_use_id": "toolu_01ABC123",                            │            │
│  │                 "content": "[Building Agentic RAG - Lesson 1]\n..."         │            │
│  │             }                                                                │            │
│  │         ]}                                                                   │            │
│  │     ]                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 8b. Call Claude WITHOUT Tools                                               │            │
│  │     final_response = client.messages.create(                                │            │
│  │         model="claude-sonnet-4-20250514",                                   │            │
│  │         temperature=0,                                                      │            │
│  │         messages=messages,                                                  │            │
│  │         system=system_content                                               │            │
│  │         # NO tools parameter - just synthesize                              │            │
│  │     )                                                                       │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════╗              │
│  ║  CLAUDE FINAL RESPONSE                                                    ║              │
│  ╠═══════════════════════════════════════════════════════════════════════════╣              │
│  ║  "MCP (Model Context Protocol) is a protocol that enables AI             ║              │
│  ║  assistants to connect to external data sources and tools. It provides    ║              │
│  ║  a standardized way for language models to access context from various    ║              │
│  ║  systems, allowing them to retrieve relevant information dynamically      ║              │
│  ║  during conversations..."                                                 ║              │
│  ╚═══════════════════════════════════════════════════════════════════════════╝              │
│                                  │                                                           │
│                                  │ return final_response.content[0].text                     │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 9: RAG SYSTEM - FINALIZE RESPONSE                                                      │
│  (backend/rag_system.py)                                                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 9a. Extract Sources from Tool                                               │            │
│  │     sources = tool_manager.get_last_sources()                               │            │
│  │     # Returns: ["Building Agentic RAG... - Lesson 1",                       │            │
│  │     #           "Building Agentic RAG... - Lesson 2", ...]                  │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 9b. Save Conversation to Session                                            │            │
│  │     session_manager.add_exchange(                                           │            │
│  │         session_id="session_1",                                             │            │
│  │         user_message="What is MCP?",                                        │            │
│  │         assistant_message="MCP (Model Context Protocol)..."                 │            │
│  │     )                                                                       │            │
│  │     # Stores in session for future context                                  │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 9c. Reset Sources                                                           │            │
│  │     tool_manager.reset_sources()                                            │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  │ return (response, sources)                                │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 10: API ENDPOINT - RETURN RESPONSE                                                     │
│  (backend/app.py)                                                                            │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 10a. Build Response Object                                                  │            │
│  │      return QueryResponse(                                                  │            │
│  │          answer="MCP (Model Context Protocol)...",                          │            │
│  │          sources=["Building Agentic RAG... - Lesson 1", ...],               │            │
│  │          session_id="session_1"                                             │            │
│  │      )                                                                      │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  │ JSON Response                                             │
│                                  ▼                                                           │
│                                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════════╗              │
│  ║  HTTP 200 OK                                                              ║              │
│  ║  {                                                                        ║              │
│  ║    "answer": "MCP (Model Context Protocol) is a protocol that...",       ║              │
│  ║    "sources": [                                                           ║              │
│  ║      "Building Agentic RAG with Claude - Lesson 1",                      ║              │
│  ║      "Building Agentic RAG with Claude - Lesson 2"                       ║              │
│  ║    ],                                                                     ║              │
│  ║    "session_id": "session_1"                                             ║              │
│  ║  }                                                                        ║              │
│  ╚═══════════════════════════════════════════════════════════════════════════╝              │
│                                  │                                                           │
│                                  ▼                                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  STEP 11: FRONTEND - DISPLAY RESPONSE                                                        │
│  (frontend/script.js)                                                                        │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 11a. Parse JSON Response                                                    │            │
│  │      const data = await response.json();                                    │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 11b. Update Session ID                                                      │            │
│  │      currentSessionId = data.session_id;  // "session_1"                    │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 11c. Remove Loading Animation                                               │            │
│  │      loadingMessage.remove();                                               │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐            │
│  │ 11d. Render Message                                                         │            │
│  │      addMessage(data.answer, 'assistant', data.sources)                     │            │
│  │                                                                              │            │
│  │      - Convert markdown to HTML: marked.parse(data.answer)                  │            │
│  │      - Create message div with content                                      │            │
│  │      - Add collapsible sources section:                                     │            │
│  │          <details class="sources-collapsible">                              │            │
│  │              <summary>Sources</summary>                                     │            │
│  │              Building Agentic RAG... - Lesson 1,                            │            │
│  │              Building Agentic RAG... - Lesson 2                             │            │
│  │          </details>                                                         │            │
│  └─────────────────────────────────────────────────────────────────────────────┘            │
│                                  │                                                           │
│                                  ▼                                                           │
│                                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────┐         │
│  │  RENDERED IN BROWSER                                                           │         │
│  ├────────────────────────────────────────────────────────────────────────────────┤         │
│  │                                                                                │         │
│  │  User:                                                                         │         │
│  │  What is MCP?                                                                  │         │
│  │                                                                                │         │
│  │  Assistant:                                                                    │         │
│  │  MCP (Model Context Protocol) is a protocol that enables AI assistants        │         │
│  │  to connect to external data sources and tools. It provides a standardized    │         │
│  │  way for language models to access context from various systems, allowing     │         │
│  │  them to retrieve relevant information dynamically during conversations...    │         │
│  │                                                                                │         │
│  │  ► Sources                                                                     │         │
│  │                                                                                │         │
│  └────────────────────────────────────────────────────────────────────────────────┘         │
│                                                                                              │
│  Next query will include session_id="session_1" for conversation continuity!                │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│  KEY COMPONENTS SUMMARY                                                                      │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  Frontend (script.js)          → HTTP POST with query                                        │
│  API Endpoint (app.py)         → Create session, route to RAG system                         │
│  RAG System (rag_system.py)    → Orchestrate all components                                  │
│  Session Manager               → Manage conversation history                                 │
│  AI Generator (ai_generator.py)→ 2 Claude API calls (tool request + synthesis)               │
│  Tool Manager (search_tools.py)→ Execute search, track sources                               │
│  Vector Store (vector_store.py)→ Semantic search in ChromaDB                                 │
│  ChromaDB                      → Vector similarity search with embeddings                    │
│                                                                                              │
│  TOTAL FLOW: ~11 steps, 2 Claude API calls, 1 vector search                                 │
│  LATENCY: Typically 2-4 seconds for complete query processing                                │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
